import * as tslib_1 from "tslib";
import { Component, Input, Output, EventEmitter, Optional, HostListener, ChangeDetectorRef } from '@angular/core';
import { FormGroup } from '@angular/forms';
import { Router, ActivatedRoute } from '@angular/router';
import * as qs from 'qs';
import { Md5 } from 'ts-md5/dist/md5';
import { SDSFormlyUpdateComunicationService } from './service/sds-filters-comunication.service';
var SdsFiltersComponent = /** @class */ (function () {
    function SdsFiltersComponent(formlyUpdateComunicationService, cdr, router, route) {
        var _this = this;
        this.formlyUpdateComunicationService = formlyUpdateComunicationService;
        this.cdr = cdr;
        this.router = router;
        this.route = route;
        /**
         *    Options for the form.
         */
        this.options = {};
        /**
         *  Emit results when model updated
         * To enable History Tracking
         *  If advanced filters dialog should be displayed -- defaults to false
         */
        this.advancedFilters = false;
        /**
         * Timer id for the timer awaiting the service call for more typeing
         */
        this.isHistoryEnable = true;
        /**
         *  Emit results when model updated
         */
        // TODO: check type -- Formly models are typically objects
        this.filterChange = new EventEmitter();
        this.sdsFilterHistory = [];
        this._isObj = function (obj) { return typeof obj === 'object' && obj !== null; };
        this._isEmpty = function (obj) { return Object.keys(obj).length === 0; };
        this.overwrite = function (baseObj, newObj) {
            var result = {};
            for (var key in baseObj) {
                if (Array.isArray(baseObj[key])) {
                    result[key] = newObj[key];
                }
                else if (_this._isObj(baseObj[key])) {
                    result[key] = _this.overwrite(baseObj[key], newObj[key] || {});
                }
                else {
                    result[key] = newObj[key] || null;
                }
            }
            return result;
        };
        this.nullify = function (obj) {
            for (var key in obj) {
                if (_this._isObj(obj[key])) {
                    obj[key] = _this.nullify(obj[key]);
                }
                else {
                    obj[key] = null;
                }
            }
            return obj;
        };
    }
    SdsFiltersComponent.prototype.onpopstate = function () {
        var queryString = window.location.search;
        var urlParams = new URLSearchParams(queryString);
        var ref = urlParams.get('ref');
        var updatedFormValue = ref == null
            ? this.nullify(this.form.value)
            : JSON.parse(localStorage.getItem(ref));
        var updatedValue = this.overwrite(this.form.getRawValue(), updatedFormValue);
        this.form.setValue(updatedValue, { emitEvent: false });
        this.updateChange(updatedFormValue);
    };
    SdsFiltersComponent.prototype.ngOnInit = function () {
        var _this = this;
        if (this.isHistoryEnable) {
            var queryString = window.location.search;
            var urlParams = new URLSearchParams(queryString);
            var initialRef = urlParams.get('ref');
            if (initialRef) {
                var updatedFormValue_1 = JSON.parse(localStorage.getItem(initialRef));
                setTimeout(function () {
                    _this.model = tslib_1.__assign({}, _this.model, updatedFormValue_1);
                    _this.updateChange(updatedFormValue_1);
                    _this.cdr.detectChanges();
                }, 0);
            }
            else {
                this.updateChange(this.model);
                this.clearStorage();
            }
        }
        this.cdr.detectChanges();
    };
    SdsFiltersComponent.prototype.onModelChange = function (change) {
        if (this.isHistoryEnable) {
            var md5 = new Md5();
            var hashCode = md5.appendStr(qs.stringify(change)).end();
            this.router.navigate([], {
                relativeTo: this.route,
                queryParams: { ref: hashCode },
                queryParamsHandling: 'merge'
            });
            this.addToStorageList(hashCode);
            localStorage.setItem(hashCode.toString(), JSON.stringify(change));
        }
        this.updateChange(change);
    };
    SdsFiltersComponent.prototype.updateChange = function (change) {
        this.filterChange.emit(change);
        if (this.formlyUpdateComunicationService) {
            this.formlyUpdateComunicationService.updateFilter(change);
        }
    };
    SdsFiltersComponent.prototype.addToStorageList = function (hashCode) {
        var list = JSON.parse(localStorage.getItem('sdsFilterHistory'));
        this.sdsFilterHistory = (list && list.length > 0) ? list : this.sdsFilterHistory;
        this.sdsFilterHistory.push(hashCode);
        localStorage.setItem('sdsFilterHistory', JSON.stringify(this.sdsFilterHistory));
    };
    SdsFiltersComponent.prototype.clearStorage = function () {
        var list = JSON.parse(localStorage.getItem('sdsFilterHistory'));
        if (list && list.length > 0) {
            var unique = list.filter(function (item, i, ar) { return ar.indexOf(item) === i; });
            unique.forEach(function (item) {
                localStorage.removeItem(item);
            });
        }
    };
    SdsFiltersComponent.decorators = [
        { type: Component, args: [{
                    selector: 'sds-filters',
                    template: "<formly-form [form]=\"form\" [fields]=\"fields\" [options]=\"options\" [model]=\"model\" (modelChange)=\"onModelChange($event)\">\n</formly-form>\n<div class=\"grid-row\">\n  <div *ngIf=\"advancedFilters\" class=\"grid-col\">\n    <sds-advanced-filters [form]=\"form\" [fields]=\"fields\" [options]=\"options\" [model]=\"model\">\n    </sds-advanced-filters>\n  </div>\n  <div class=\"grid-col text-right\">\n    <sds-formly-reset [options]=\"options\"></sds-formly-reset>\n  </div>\n</div>\n"
                }] }
    ];
    /** @nocollapse */
    SdsFiltersComponent.ctorParameters = function () { return [
        { type: SDSFormlyUpdateComunicationService, decorators: [{ type: Optional }] },
        { type: ChangeDetectorRef },
        { type: Router },
        { type: ActivatedRoute }
    ]; };
    SdsFiltersComponent.propDecorators = {
        form: [{ type: Input }],
        fields: [{ type: Input }],
        model: [{ type: Input }],
        options: [{ type: Input }],
        advancedFilters: [{ type: Input }],
        isHistoryEnable: [{ type: Input }],
        filterChange: [{ type: Output }],
        onpopstate: [{ type: HostListener, args: ['window:popstate', [''],] }]
    };
    return SdsFiltersComponent;
}());
export { SdsFiltersComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2RzLWZpbHRlcnMuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGdzYS1zYW0vc2FtLWZvcm1seS8iLCJzb3VyY2VzIjpbImxpYi9mb3JtbHktZmlsdGVycy9zZHMtZmlsdGVycy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBQ1osUUFBUSxFQUNSLFlBQVksRUFFWixpQkFBaUIsRUFDbEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTNDLE9BQU8sRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekQsT0FBTyxLQUFLLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRXRDLE9BQU8sRUFBRSxrQ0FBa0MsRUFBRSxNQUFNLDRDQUE0QyxDQUFDO0FBRWhHO0lBd0VFLDZCQUVTLCtCQUFtRSxFQUNsRSxHQUFzQixFQUN0QixNQUFjLEVBQ2QsS0FBcUI7UUFML0IsaUJBTUs7UUFKSSxvQ0FBK0IsR0FBL0IsK0JBQStCLENBQW9DO1FBQ2xFLFFBQUcsR0FBSCxHQUFHLENBQW1CO1FBQ3RCLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCxVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQXhEL0I7O1dBRUc7UUFDYSxZQUFPLEdBQXNCLEVBQUUsQ0FBQztRQUVoRDs7OztXQUlHO1FBQ00sb0JBQWUsR0FBWSxLQUFLLENBQUM7UUFFMUM7O1dBRUc7UUFDYSxvQkFBZSxHQUFZLElBQUksQ0FBQztRQUVoRDs7V0FFRztRQUNILDBEQUEwRDtRQUNoRCxpQkFBWSxHQUFHLElBQUksWUFBWSxFQUFZLENBQUM7UUFFdEQscUJBQWdCLEdBQUcsRUFBRSxDQUFDO1FBRXRCLFdBQU0sR0FBRyxVQUFD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QUFJLEVBQUUsQ0FBQyxFQUFFLEVBQUUsSUFBSyxPQUFBLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUF0QixDQUFzQixDQUFDLENBQUM7WUFDcEUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFBLElBQUk7Z0JBQ2pCLFlBQVksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDaEMsQ0FBQyxDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7O2dCQTFKRixTQUFTLFNBQUM7b0JBQ1QsUUFBUSxFQUFFLGFBQWE7b0JBQ3ZCLHdmQUEyQztpQkFDNUM7Ozs7Z0JBTFEsa0NBQWtDLHVCQTJFdEMsUUFBUTtnQkFuRlgsaUJBQWlCO2dCQUlWLE1BQU07Z0JBQUUsY0FBYzs7O3VCQWU1QixLQUFLO3lCQUtMLEtBQUs7d0JBS0wsS0FBSzswQkFLTCxLQUFLO2tDQU9MLEtBQUs7a0NBS0wsS0FBSzsrQkFNTCxNQUFNOzZCQXNDTixZQUFZLFNBQUMsaUJBQWlCLEVBQUUsQ0FBQyxFQUFFLENBQUM7O0lBMkV2QywwQkFBQztDQUFBLEFBM0pELElBMkpDO1NBdEpZLG1CQUFtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgSW5wdXQsXG4gIE91dHB1dCxcbiAgRXZlbnRFbWl0dGVyLFxuICBPcHRpb25hbCxcbiAgSG9zdExpc3RlbmVyLFxuICBPbkluaXQsXG4gIENoYW5nZURldGVjdG9yUmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRm9ybUdyb3VwIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgRm9ybWx5RmllbGRDb25maWcsIEZvcm1seUZvcm1PcHRpb25zIH0gZnJvbSAnQG5neC1mb3JtbHkvY29yZSc7XG5pbXBvcnQgeyBSb3V0ZXIsIEFjdGl2YXRlZFJvdXRlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCAqIGFzIHFzIGZyb20gJ3FzJztcbmltcG9ydCB7IE1kNSB9IGZyb20gJ3RzLW1kNS9kaXN0L21kNSc7XG5cbmltcG9ydCB7IFNEU0Zvcm1seVVwZGF0ZUNvbXVuaWNhdGlvblNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2Uvc2RzLWZpbHRlcnMtY29tdW5pY2F0aW9uLnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdzZHMtZmlsdGVycycsXG4gIHRlbXBsYXRlVXJsOiAnLi9zZHMtZmlsdGVycy5jb21wb25lbnQuaHRtbCdcbn0pXG5cbmV4cG9ydCBjbGFzcyBTZHNGaWx0ZXJzQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgLyoqXG4gICAqIFBhc3MgaW4gYSBGb3JtIEdyb3VwIGZvciBSZWFjdGl2ZUZvcm1zIFN1cHBvcnRcbiAgICovXG4gIEBJbnB1dCgpIHB1YmxpYyBmb3JtOiBGb3JtR3JvdXA7XG5cbiAgLyoqXG4gICAqICBGaWVsZHMgYXJlIHVzZWQgdG8gY29uZmlndXJlIHRoZSBVSSBjb21wb25lbnRzXG4gICAqL1xuICBASW5wdXQoKSBwdWJsaWMgZmllbGRzOiBGb3JtbHlGaWVsZENvbmZpZ1tdO1xuXG4gIC8qKlxuICAgKiAgTW9kZWwgdXNlZCB0byBkaXNwbGF5IHRoZSBmaWx0ZXIgdmFsdWVzLlxuICAgKi9cbiAgQElucHV0KCkgcHVibGljIG1vZGVsOiBhbnk7XG5cbiAgLyoqXG4gICAqICAgIE9wdGlvbnMgZm9yIHRoZSBmb3JtLlxuICAgKi9cbiAgQElucHV0KCkgcHVibGljIG9wdGlvbnM6IEZvcm1seUZvcm1PcHRpb25zID0ge307XG5cbiAgLyoqXG4gICAqICBFbWl0IHJlc3VsdHMgd2hlbiBtb2RlbCB1cGRhdGVkXG4gICAqIFRvIGVuYWJsZSBIaXN0b3J5IFRyYWNraW5nXG4gICAqICBJZiBhZHZhbmNlZCBmaWx0ZXJzIGRpYWxvZyBzaG91bGQgYmUgZGlzcGxheWVkIC0tIGRlZmF1bHRzIHRvIGZhbHNlXG4gICAqL1xuICBASW5wdXQoKSBhZHZhbmNlZEZpbHRlcnM6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAvKipcbiAgICogVGltZXIgaWQgZm9yIHRoZSB0aW1lciBhd2FpdGluZyB0aGUgc2VydmljZSBjYWxsIGZvciBtb3JlIHR5cGVpbmdcbiAgICovXG4gIEBJbnB1dCgpIHB1YmxpYyBpc0hpc3RvcnlFbmFibGU6IGJvb2xlYW4gPSB0cnVlO1xuXG4gIC8qKlxuICAgKiAgRW1pdCByZXN1bHRzIHdoZW4gbW9kZWwgdXBkYXRlZFxuICAgKi9cbiAgLy8gVE9ETzogY2hlY2sgdHlwZSAtLSBGb3JtbHkgbW9kZWxzIGFyZSB0eXBpY2FsbHkgb2JqZWN0c1xuICBAT3V0cHV0KCkgZmlsdGVyQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxvYmplY3RbXT4oKTtcblxuICBzZHNGaWx0ZXJIaXN0b3J5ID0gW107XG5cbiAgX2lzT2JqID0gKG9iajogYW55KTogYm9vbGVhbiA9PiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyAmJiBvYmogIT09IG51bGw7XG4gIF9pc0VtcHR5ID0gKG9iajogYW55KTogYm9vbGVhbiA9PiBPYmplY3Qua2V5cyhvYmopLmxlbmd0aCA9PT0gMDtcbiAgb3ZlcndyaXRlID0gKGJhc2VPYmo6IGFueSwgbmV3T2JqOiBhbnkpID0+IHtcbiAgICBsZXQgcmVzdWx0ID0ge307XG4gICAgZm9yIChsZXQga2V5IGluIGJhc2VPYmopIHtcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGJhc2VPYmpba2V5XSkpIHtcbiAgICAgICAgcmVzdWx0W2tleV0gPSBuZXdPYmpba2V5XTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5faXNPYmooYmFzZU9ialtrZXldKSkge1xuICAgICAgICByZXN1bHRba2V5XSA9IHRoaXMub3ZlcndyaXRlKGJhc2VPYmpba2V5XSwgbmV3T2JqW2tleV0gfHwge30pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzdWx0W2tleV0gPSBuZXdPYmpba2V5XSB8fCBudWxsO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuICBudWxsaWZ5ID0gKG9iajogYW55KSA9PiB7XG4gICAgZm9yIChsZXQga2V5IGluIG9iaikge1xuICAgICAgaWYgKHRoaXMuX2lzT2JqKG9ialtrZXldKSkge1xuICAgICAgICBvYmpba2V5XSA9IHRoaXMubnVsbGlmeShvYmpba2V5XSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvYmpba2V5XSA9IG51bGw7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBvYmo7XG4gIH07XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQE9wdGlvbmFsKClcbiAgICBwdWJsaWMgZm9ybWx5VXBkYXRlQ29tdW5pY2F0aW9uU2VydmljZTogU0RTRm9ybWx5VXBkYXRlQ29tdW5pY2F0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcbiAgICBwcml2YXRlIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVxuICApIHsgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ3dpbmRvdzpwb3BzdGF0ZScsIFsnJ10pXG4gIG9ucG9wc3RhdGUoKSB7XG4gICAgY29uc3QgcXVlcnlTdHJpbmcgPSB3aW5kb3cubG9jYXRpb24uc2VhcmNoO1xuICAgIGNvbnN0IHVybFBhcmFtcyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMocXVlcnlTdHJpbmcpO1xuICAgIGNvbnN0IHJlZiA9IHVybFBhcmFtcy5nZXQoJ3JlZicpO1xuICAgIGNvbnN0IHVwZGF0ZWRGb3JtVmFsdWUgPVxuICAgICAgcmVmID09IG51bGxcbiAgICAgICAgPyB0aGlzLm51bGxpZnkodGhpcy5mb3JtLnZhbHVlKVxuICAgICAgICA6IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0ocmVmKSk7XG4gICAgY29uc3QgdXBkYXRlZFZhbHVlID0gdGhpcy5vdmVyd3JpdGUoXG4gICAgICB0aGlzLmZvcm0uZ2V0UmF3VmFsdWUoKSxcbiAgICAgIHVwZGF0ZWRGb3JtVmFsdWVcbiAgICApO1xuICAgIHRoaXMuZm9ybS5zZXRWYWx1ZSh1cGRhdGVkVmFsdWUsIHsgZW1pdEV2ZW50OiBmYWxzZSB9KTtcbiAgICB0aGlzLnVwZGF0ZUNoYW5nZSh1cGRhdGVkRm9ybVZhbHVlKTtcbiAgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmlzSGlzdG9yeUVuYWJsZSkge1xuICAgICAgY29uc3QgcXVlcnlTdHJpbmcgPSB3aW5kb3cubG9jYXRpb24uc2VhcmNoO1xuICAgICAgY29uc3QgdXJsUGFyYW1zID0gbmV3IFVSTFNlYXJjaFBhcmFtcyhxdWVyeVN0cmluZyk7XG4gICAgICBjb25zdCBpbml0aWFsUmVmID0gdXJsUGFyYW1zLmdldCgncmVmJyk7XG4gICAgICBpZiAoaW5pdGlhbFJlZikge1xuICAgICAgICBjb25zdCB1cGRhdGVkRm9ybVZhbHVlID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShpbml0aWFsUmVmKSk7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIHRoaXMubW9kZWwgPSB7IC4uLnRoaXMubW9kZWwsIC4uLnVwZGF0ZWRGb3JtVmFsdWUgfVxuICAgICAgICAgIHRoaXMudXBkYXRlQ2hhbmdlKHVwZGF0ZWRGb3JtVmFsdWUpO1xuICAgICAgICAgIHRoaXMuY2RyLmRldGVjdENoYW5nZXMoKTtcbiAgICAgICAgfSwgMCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgdGhpcy51cGRhdGVDaGFuZ2UodGhpcy5tb2RlbCk7XG4gICAgICB0aGlzLmNsZWFyU3RvcmFnZSgpO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmNkci5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBvbk1vZGVsQ2hhbmdlKGNoYW5nZTogYW55KSB7XG4gICAgaWYgKHRoaXMuaXNIaXN0b3J5RW5hYmxlKSB7XG4gICAgICBjb25zdCBtZDUgPSBuZXcgTWQ1KCk7XG4gICAgICBjb25zdCBoYXNoQ29kZSA9IG1kNS5hcHBlbmRTdHIocXMuc3RyaW5naWZ5KGNoYW5nZSkpLmVuZCgpO1xuICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoW10sIHtcbiAgICAgICAgcmVsYXRpdmVUbzogdGhpcy5yb3V0ZSxcbiAgICAgICAgcXVlcnlQYXJhbXM6IHsgcmVmOiBoYXNoQ29kZSB9LFxuICAgICAgICBxdWVyeVBhcmFtc0hhbmRsaW5nOiAnbWVyZ2UnXG4gICAgICB9KTtcbiAgICAgIHRoaXMuYWRkVG9TdG9yYWdlTGlzdChoYXNoQ29kZSlcbiAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGhhc2hDb2RlLnRvU3RyaW5nKCksIEpTT04uc3RyaW5naWZ5KGNoYW5nZSkpO1xuICAgIH1cbiAgICB0aGlzLnVwZGF0ZUNoYW5nZShjaGFuZ2UpO1xuICB9XG5cbiAgdXBkYXRlQ2hhbmdlKGNoYW5nZSkge1xuICAgIHRoaXMuZmlsdGVyQ2hhbmdlLmVtaXQoY2hhbmdlKTtcbiAgICBpZiAodGhpcy5mb3JtbHlVcGRhdGVDb211bmljYXRpb25TZXJ2aWNlKSB7XG4gICAgICB0aGlzLmZvcm1seVVwZGF0ZUNvbXVuaWNhdGlvblNlcnZpY2UudXBkYXRlRmlsdGVyKGNoYW5nZSk7XG4gICAgfVxuICB9XG5cbiAgYWRkVG9TdG9yYWdlTGlzdChoYXNoQ29kZSkge1xuICAgIGNvbnN0IGxpc3QgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdzZHNGaWx0ZXJIaXN0b3J5JykpO1xuICAgIHRoaXMuc2RzRmlsdGVySGlzdG9yeSA9IChsaXN0ICYmIGxpc3QubGVuZ3RoID4gMCkgPyBsaXN0IDogdGhpcy5zZHNGaWx0ZXJIaXN0b3J5XG4gICAgdGhpcy5zZHNGaWx0ZXJIaXN0b3J5LnB1c2goaGFzaENvZGUpO1xuICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdzZHNGaWx0ZXJIaXN0b3J5JywgSlNPTi5zdHJpbmdpZnkodGhpcy5zZHNGaWx0ZXJIaXN0b3J5KSk7XG4gIH1cblxuICBjbGVhclN0b3JhZ2UoKSB7XG4gICAgY29uc3QgbGlzdCA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3Nkc0ZpbHRlckhpc3RvcnknKSk7XG4gICAgaWYgKGxpc3QgJiYgbGlzdC5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCB1bmlxdWUgPSBsaXN0LmZpbHRlcigoaXRlbSwgaSwgYXIpID0+IGFyLmluZGV4T2YoaXRlbSkgPT09IGkpO1xuICAgICAgdW5pcXVlLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGl0ZW0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG59XG4iXX0=