import { Component, Input, Output, EventEmitter, Optional, HostListener, ChangeDetectorRef } from '@angular/core';
import { FormGroup } from '@angular/forms';
import { Router, ActivatedRoute } from '@angular/router';
import * as qs from 'qs';
import { Md5 } from 'ts-md5/dist/md5';
import { SDSFormlyUpdateComunicationService } from './service/sds-filters-comunication.service';
export class SdsFiltersComponent {
    constructor(formlyUpdateComunicationService, cdr, router, route) {
        this.formlyUpdateComunicationService = formlyUpdateComunicationService;
        this.cdr = cdr;
        this.router = router;
        this.route = route;
        /**
         *    Options for the form.
         */
        this.options = {};
        /**
         *  Emit results when model updated
         * To enable History Tracking
         *  If advanced filters dialog should be displayed -- defaults to false
         */
        this.advancedFilters = false;
        /**
         * Timer id for the timer awaiting the service call for more typeing
         */
        this.isHistoryEnable = true;
        /**
         *  Emit results when model updated
         */
        // TODO: check type -- Formly models are typically objects
        this.filterChange = new EventEmitter();
        this.sdsFilterHistory = [];
        this._isObj = (obj) => typeof obj === 'object' && obj !== null;
        this._isEmpty = (obj) => Object.keys(obj).length === 0;
        this.overwrite = (baseObj, newObj) => {
            let result = {};
            for (let key in baseObj) {
                if (Array.isArray(baseObj[key])) {
                    result[key] = newObj[key];
                }
                else if (this._isObj(baseObj[key])) {
                    result[key] = this.overwrite(baseObj[key], newObj[key] || {});
                }
                else {
                    result[key] = newObj[key] || null;
                }
            }
            return result;
        };
        this.nullify = (obj) => {
            for (let key in obj) {
                if (this._isObj(obj[key])) {
                    obj[key] = this.nullify(obj[key]);
                }
                else {
                    obj[key] = null;
                }
            }
            return obj;
        };
    }
    onpopstate() {
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const ref = urlParams.get('ref');
        const updatedFormValue = ref == null
            ? this.nullify(this.form.value)
            : JSON.parse(localStorage.getItem(ref));
        const updatedValue = this.overwrite(this.form.getRawValue(), updatedFormValue);
        this.form.setValue(updatedValue, { emitEvent: false });
        this.updateChange(updatedFormValue);
    }
    ngOnInit() {
        if (this.isHistoryEnable) {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const initialRef = urlParams.get('ref');
            if (initialRef) {
                const updatedFormValue = JSON.parse(localStorage.getItem(initialRef));
                setTimeout(() => {
                    this.model = Object.assign({}, this.model, updatedFormValue);
                    this.updateChange(updatedFormValue);
                    this.cdr.detectChanges();
                }, 0);
            }
            else {
                this.updateChange(this.model);
                this.clearStorage();
            }
        }
        this.cdr.detectChanges();
    }
    onModelChange(change) {
        if (this.isHistoryEnable) {
            const md5 = new Md5();
            const hashCode = md5.appendStr(qs.stringify(change)).end();
            this.router.navigate([], {
                relativeTo: this.route,
                queryParams: { ref: hashCode },
                queryParamsHandling: 'merge'
            });
            this.addToStorageList(hashCode);
            localStorage.setItem(hashCode.toString(), JSON.stringify(change));
        }
        this.updateChange(change);
    }
    updateChange(change) {
        this.filterChange.emit(change);
        if (this.formlyUpdateComunicationService) {
            this.formlyUpdateComunicationService.updateFilter(change);
        }
    }
    addToStorageList(hashCode) {
        const list = JSON.parse(localStorage.getItem('sdsFilterHistory'));
        this.sdsFilterHistory = (list && list.length > 0) ? list : this.sdsFilterHistory;
        this.sdsFilterHistory.push(hashCode);
        localStorage.setItem('sdsFilterHistory', JSON.stringify(this.sdsFilterHistory));
    }
    clearStorage() {
        const list = JSON.parse(localStorage.getItem('sdsFilterHistory'));
        if (list && list.length > 0) {
            const unique = list.filter((item, i, ar) => ar.indexOf(item) === i);
            unique.forEach(item => {
                localStorage.removeItem(item);
            });
        }
    }
}
SdsFiltersComponent.decorators = [
    { type: Component, args: [{
                selector: 'sds-filters',
                template: "<formly-form [form]=\"form\" [fields]=\"fields\" [options]=\"options\" [model]=\"model\" (modelChange)=\"onModelChange($event)\">\n</formly-form>\n<div class=\"grid-row\">\n  <div *ngIf=\"advancedFilters\" class=\"grid-col\">\n    <sds-advanced-filters [form]=\"form\" [fields]=\"fields\" [options]=\"options\" [model]=\"model\">\n    </sds-advanced-filters>\n  </div>\n  <div class=\"grid-col text-right\">\n    <sds-formly-reset [options]=\"options\"></sds-formly-reset>\n  </div>\n</div>\n"
            }] }
];
/** @nocollapse */
SdsFiltersComponent.ctorParameters = () => [
    { type: SDSFormlyUpdateComunicationService, decorators: [{ type: Optional }] },
    { type: ChangeDetectorRef },
    { type: Router },
    { type: ActivatedRoute }
];
SdsFiltersComponent.propDecorators = {
    form: [{ type: Input }],
    fields: [{ type: Input }],
    model: [{ type: Input }],
    options: [{ type: Input }],
    advancedFilters: [{ type: Input }],
    isHistoryEnable: [{ type: Input }],
    filterChange: [{ type: Output }],
    onpopstate: [{ type: HostListener, args: ['window:popstate', [''],] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2RzLWZpbHRlcnMuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGdzYS1zYW0vc2FtLWZvcm1seS8iLCJzb3VyY2VzIjpbImxpYi9mb3JtbHktZmlsdGVycy9zZHMtZmlsdGVycy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsTUFBTSxFQUNOLFlBQVksRUFDWixRQUFRLEVBQ1IsWUFBWSxFQUVaLGlCQUFpQixFQUNsQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6RCxPQUFPLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQztBQUN6QixPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFdEMsT0FBTyxFQUFFLGtDQUFrQyxFQUFFLE1BQU0sNENBQTRDLENBQUM7QUFPaEcsTUFBTSxPQUFPLG1CQUFtQjtJQW1FOUIsWUFFUywrQkFBbUUsRUFDbEUsR0FBc0IsRUFDdEIsTUFBYyxFQUNkLEtBQXFCO1FBSHRCLG9DQUErQixHQUEvQiwrQkFBK0IsQ0FBb0M7UUFDbEUsUUFBRyxHQUFILEdBQUcsQ0FBbUI7UUFDdEIsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLFVBQUssR0FBTCxLQUFLLENBQWdCO1FBeEQvQjs7V0FFRztRQUNhLFlBQU8sR0FBc0IsRUFBRSxDQUFDO1FBRWhEOzs7O1dBSUc7UUFDTSxvQkFBZSxHQUFZLEtBQUssQ0FBQztRQUUxQzs7V0FFRztRQUNhLG9CQUFlLEdBQVksSUFBSSxDQUFDO1FBRWhEOztXQUVHO1FBQ0gsMERBQTBEO1FBQ2hELGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQVksQ0FBQztRQUV0RCxxQkFBZ0IsR0FBRyxFQUFFLENBQUM7UUFFdEIsV0FBTSxHQUFH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RUFBRSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDcEUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDcEIsWUFBWSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNoQyxDQUFDLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQzs7O1lBMUpGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsYUFBYTtnQkFDdkIsd2ZBQTJDO2FBQzVDOzs7O1lBTFEsa0NBQWtDLHVCQTJFdEMsUUFBUTtZQW5GWCxpQkFBaUI7WUFJVixNQUFNO1lBQUUsY0FBYzs7O21CQWU1QixLQUFLO3FCQUtMLEtBQUs7b0JBS0wsS0FBSztzQkFLTCxLQUFLOzhCQU9MLEtBQUs7OEJBS0wsS0FBSzsyQkFNTCxNQUFNO3lCQXNDTixZQUFZLFNBQUMsaUJBQWlCLEVBQUUsQ0FBQyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIElucHV0LFxuICBPdXRwdXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgT3B0aW9uYWwsXG4gIEhvc3RMaXN0ZW5lcixcbiAgT25Jbml0LFxuICBDaGFuZ2VEZXRlY3RvclJlZlxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZvcm1Hcm91cCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IEZvcm1seUZpZWxkQ29uZmlnLCBGb3JtbHlGb3JtT3B0aW9ucyB9IGZyb20gJ0BuZ3gtZm9ybWx5L2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyLCBBY3RpdmF0ZWRSb3V0ZSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgKiBhcyBxcyBmcm9tICdxcyc7XG5pbXBvcnQgeyBNZDUgfSBmcm9tICd0cy1tZDUvZGlzdC9tZDUnO1xuXG5pbXBvcnQgeyBTRFNGb3JtbHlVcGRhdGVDb211bmljYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlL3Nkcy1maWx0ZXJzLWNvbXVuaWNhdGlvbi5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnc2RzLWZpbHRlcnMnLFxuICB0ZW1wbGF0ZVVybDogJy4vc2RzLWZpbHRlcnMuY29tcG9uZW50Lmh0bWwnXG59KVxuXG5leHBvcnQgY2xhc3MgU2RzRmlsdGVyc0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG4gIC8qKlxuICAgKiBQYXNzIGluIGEgRm9ybSBHcm91cCBmb3IgUmVhY3RpdmVGb3JtcyBTdXBwb3J0XG4gICAqL1xuICBASW5wdXQoKSBwdWJsaWMgZm9ybTogRm9ybUdyb3VwO1xuXG4gIC8qKlxuICAgKiAgRmllbGRzIGFyZSB1c2VkIHRvIGNvbmZpZ3VyZSB0aGUgVUkgY29tcG9uZW50c1xuICAgKi9cbiAgQElucHV0KCkgcHVibGljIGZpZWxkczogRm9ybWx5RmllbGRDb25maWdbXTtcblxuICAvKipcbiAgICogIE1vZGVsIHVzZWQgdG8gZGlzcGxheSB0aGUgZmlsdGVyIHZhbHVlcy5cbiAgICovXG4gIEBJbnB1dCgpIHB1YmxpYyBtb2RlbDogYW55O1xuXG4gIC8qKlxuICAgKiAgICBPcHRpb25zIGZvciB0aGUgZm9ybS5cbiAgICovXG4gIEBJbnB1dCgpIHB1YmxpYyBvcHRpb25zOiBGb3JtbHlGb3JtT3B0aW9ucyA9IHt9O1xuXG4gIC8qKlxuICAgKiAgRW1pdCByZXN1bHRzIHdoZW4gbW9kZWwgdXBkYXRlZFxuICAgKiBUbyBlbmFibGUgSGlzdG9yeSBUcmFja2luZ1xuICAgKiAgSWYgYWR2YW5jZWQgZmlsdGVycyBkaWFsb2cgc2hvdWxkIGJlIGRpc3BsYXllZCAtLSBkZWZhdWx0cyB0byBmYWxzZVxuICAgKi9cbiAgQElucHV0KCkgYWR2YW5jZWRGaWx0ZXJzOiBib29sZWFuID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIFRpbWVyIGlkIGZvciB0aGUgdGltZXIgYXdhaXRpbmcgdGhlIHNlcnZpY2UgY2FsbCBmb3IgbW9yZSB0eXBlaW5nXG4gICAqL1xuICBASW5wdXQoKSBwdWJsaWMgaXNIaXN0b3J5RW5hYmxlOiBib29sZWFuID0gdHJ1ZTtcblxuICAvKipcbiAgICogIEVtaXQgcmVzdWx0cyB3aGVuIG1vZGVsIHVwZGF0ZWRcbiAgICovXG4gIC8vIFRPRE86IGNoZWNrIHR5cGUgLS0gRm9ybWx5IG1vZGVscyBhcmUgdHlwaWNhbGx5IG9iamVjdHNcbiAgQE91dHB1dCgpIGZpbHRlckNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8b2JqZWN0W10+KCk7XG5cbiAgc2RzRmlsdGVySGlzdG9yeSA9IFtdO1xuXG4gIF9pc09iaiA9IChvYmo6IGFueSk6IGJvb2xlYW4gPT4gdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgJiYgb2JqICE9PSBudWxsO1xuICBfaXNFbXB0eSA9IChvYmo6IGFueSk6IGJvb2xlYW4gPT4gT2JqZWN0LmtleXMob2JqKS5sZW5ndGggPT09IDA7XG4gIG92ZXJ3cml0ZSA9IChiYXNlT2JqOiBhbnksIG5ld09iajogYW55KSA9PiB7XG4gICAgbGV0IHJlc3VsdCA9IHt9O1xuICAgIGZvciAobGV0IGtleSBpbiBiYXNlT2JqKSB7XG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShiYXNlT2JqW2tleV0pKSB7XG4gICAgICAgIHJlc3VsdFtrZXldID0gbmV3T2JqW2tleV07XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuX2lzT2JqKGJhc2VPYmpba2V5XSkpIHtcbiAgICAgICAgcmVzdWx0W2tleV0gPSB0aGlzLm92ZXJ3cml0ZShiYXNlT2JqW2tleV0sIG5ld09ialtrZXldIHx8IHt9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3VsdFtrZXldID0gbmV3T2JqW2tleV0gfHwgbnVsbDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfTtcbiAgbnVsbGlmeSA9IChvYmo6IGFueSkgPT4ge1xuICAgIGZvciAobGV0IGtleSBpbiBvYmopIHtcbiAgICAgIGlmICh0aGlzLl9pc09iaihvYmpba2V5XSkpIHtcbiAgICAgICAgb2JqW2tleV0gPSB0aGlzLm51bGxpZnkob2JqW2tleV0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb2JqW2tleV0gPSBudWxsO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gb2JqO1xuICB9O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBPcHRpb25hbCgpXG4gICAgcHVibGljIGZvcm1seVVwZGF0ZUNvbXVuaWNhdGlvblNlcnZpY2U6IFNEU0Zvcm1seVVwZGF0ZUNvbXVuaWNhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSBjZHI6IENoYW5nZURldGVjdG9yUmVmLFxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXG4gICAgcHJpdmF0ZSByb3V0ZTogQWN0aXZhdGVkUm91dGVcbiAgKSB7IH1cblxuICBASG9zdExpc3RlbmVyKCd3aW5kb3c6cG9wc3RhdGUnLCBbJyddKVxuICBvbnBvcHN0YXRlKCkge1xuICAgIGNvbnN0IHF1ZXJ5U3RyaW5nID0gd2luZG93LmxvY2F0aW9uLnNlYXJjaDtcbiAgICBjb25zdCB1cmxQYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHF1ZXJ5U3RyaW5nKTtcbiAgICBjb25zdCByZWYgPSB1cmxQYXJhbXMuZ2V0KCdyZWYnKTtcbiAgICBjb25zdCB1cGRhdGVkRm9ybVZhbHVlID1cbiAgICAgIHJlZiA9PSBudWxsXG4gICAgICAgID8gdGhpcy5udWxsaWZ5KHRoaXMuZm9ybS52YWx1ZSlcbiAgICAgICAgOiBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKHJlZikpO1xuICAgIGNvbnN0IHVwZGF0ZWRWYWx1ZSA9IHRoaXMub3ZlcndyaXRlKFxuICAgICAgdGhpcy5mb3JtLmdldFJhd1ZhbHVlKCksXG4gICAgICB1cGRhdGVkRm9ybVZhbHVlXG4gICAgKTtcbiAgICB0aGlzLmZvcm0uc2V0VmFsdWUodXBkYXRlZFZhbHVlLCB7IGVtaXRFdmVudDogZmFsc2UgfSk7XG4gICAgdGhpcy51cGRhdGVDaGFuZ2UodXBkYXRlZEZvcm1WYWx1ZSk7XG4gIH1cblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5pc0hpc3RvcnlFbmFibGUpIHtcbiAgICAgIGNvbnN0IHF1ZXJ5U3RyaW5nID0gd2luZG93LmxvY2F0aW9uLnNlYXJjaDtcbiAgICAgIGNvbnN0IHVybFBhcmFtcyA9IG5ldyBVUkxTZWFyY2hQYXJhbXMocXVlcnlTdHJpbmcpO1xuICAgICAgY29uc3QgaW5pdGlhbFJlZiA9IHVybFBhcmFtcy5nZXQoJ3JlZicpO1xuICAgICAgaWYgKGluaXRpYWxSZWYpIHtcbiAgICAgICAgY29uc3QgdXBkYXRlZEZvcm1WYWx1ZSA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oaW5pdGlhbFJlZikpO1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB0aGlzLm1vZGVsID0geyAuLi50aGlzLm1vZGVsLCAuLi51cGRhdGVkRm9ybVZhbHVlIH1cbiAgICAgICAgICB0aGlzLnVwZGF0ZUNoYW5nZSh1cGRhdGVkRm9ybVZhbHVlKTtcbiAgICAgICAgICB0aGlzLmNkci5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgICAgIH0sIDApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudXBkYXRlQ2hhbmdlKHRoaXMubW9kZWwpO1xuICAgICAgdGhpcy5jbGVhclN0b3JhZ2UoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5jZHIuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgb25Nb2RlbENoYW5nZShjaGFuZ2U6IGFueSkge1xuICAgIGlmICh0aGlzLmlzSGlzdG9yeUVuYWJsZSkge1xuICAgICAgY29uc3QgbWQ1ID0gbmV3IE1kNSgpO1xuICAgICAgY29uc3QgaGFzaENvZGUgPSBtZDUuYXBwZW5kU3RyKHFzLnN0cmluZ2lmeShjaGFuZ2UpKS5lbmQoKTtcbiAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFtdLCB7XG4gICAgICAgIHJlbGF0aXZlVG86IHRoaXMucm91dGUsXG4gICAgICAgIHF1ZXJ5UGFyYW1zOiB7IHJlZjogaGFzaENvZGUgfSxcbiAgICAgICAgcXVlcnlQYXJhbXNIYW5kbGluZzogJ21lcmdlJ1xuICAgICAgfSk7XG4gICAgICB0aGlzLmFkZFRvU3RvcmFnZUxpc3QoaGFzaENvZGUpXG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShoYXNoQ29kZS50b1N0cmluZygpLCBKU09OLnN0cmluZ2lmeShjaGFuZ2UpKTtcbiAgICB9XG4gICAgdGhpcy51cGRhdGVDaGFuZ2UoY2hhbmdlKTtcbiAgfVxuXG4gIHVwZGF0ZUNoYW5nZShjaGFuZ2UpIHtcbiAgICB0aGlzLmZpbHRlckNoYW5nZS5lbWl0KGNoYW5nZSk7XG4gICAgaWYgKHRoaXMuZm9ybWx5VXBkYXRlQ29tdW5pY2F0aW9uU2VydmljZSkge1xuICAgICAgdGhpcy5mb3JtbHlVcGRhdGVDb211bmljYXRpb25TZXJ2aWNlLnVwZGF0ZUZpbHRlcihjaGFuZ2UpO1xuICAgIH1cbiAgfVxuXG4gIGFkZFRvU3RvcmFnZUxpc3QoaGFzaENvZGUpIHtcbiAgICBjb25zdCBsaXN0ID0gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnc2RzRmlsdGVySGlzdG9yeScpKTtcbiAgICB0aGlzLnNkc0ZpbHRlckhpc3RvcnkgPSAobGlzdCAmJiBsaXN0Lmxlbmd0aCA+IDApID8gbGlzdCA6IHRoaXMuc2RzRmlsdGVySGlzdG9yeVxuICAgIHRoaXMuc2RzRmlsdGVySGlzdG9yeS5wdXNoKGhhc2hDb2RlKTtcbiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnc2RzRmlsdGVySGlzdG9yeScsIEpTT04uc3RyaW5naWZ5KHRoaXMuc2RzRmlsdGVySGlzdG9yeSkpO1xuICB9XG5cbiAgY2xlYXJTdG9yYWdlKCkge1xuICAgIGNvbnN0IGxpc3QgPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdzZHNGaWx0ZXJIaXN0b3J5JykpO1xuICAgIGlmIChsaXN0ICYmIGxpc3QubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgdW5pcXVlID0gbGlzdC5maWx0ZXIoKGl0ZW0sIGksIGFyKSA9PiBhci5pbmRleE9mKGl0ZW0pID09PSBpKTtcbiAgICAgIHVuaXF1ZS5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShpdGVtKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxufVxuIl19