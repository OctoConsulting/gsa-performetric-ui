/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, ElementRef, Input, HostListener, Injector, ViewContainerRef } from '@angular/core';
import { coerceNumberProperty } from '@angular/cdk/coercion';
import { ViewportRuler, OverlayConfig, Overlay } from '@angular/cdk/overlay';
import { Subscription, merge } from 'rxjs';
import { startWith } from 'rxjs/operators';
import { PortalInjector, ComponentPortal } from '@angular/cdk/portal';
import { SdsTruncatedTextContainerComponent } from './truncate-text-container.component';
import { SDS_TRUNCATED_TEXT_DATA } from './truncates-text-base';
var SdsTruncateTextByLineDirective = /** @class */ (function () {
    function SdsTruncateTextByLineDirective(_overlay, _injector, _element, _viewportRuler, _viewContainerRef) {
        this._overlay = _overlay;
        this._injector = _injector;
        this._element = _element;
        this._viewportRuler = _viewportRuler;
        this._viewContainerRef = _viewContainerRef;
        /**
         * PortalOutlet
         */
        this._overlayRef = null;
        /**
         * Holds subscription to stream of overlay closing events
         */
        this._closingActionsSubscription = Subscription.EMPTY;
    }
    Object.defineProperty(SdsTruncateTextByLineDirective.prototype, "textLinesLimit", {
        /** Maximum lines of text limit */
        get: /**
         * Maximum lines of text limit
         * @return {?}
         */
        function () {
            return this._textLinesLimit;
        },
        set: /**
         * @param {?} _textLinesLimit
         * @return {?}
         */
        function (_textLinesLimit) {
            _textLinesLimit = coerceNumberProperty(_textLinesLimit);
            if (this._textLinesLimit !== _textLinesLimit) {
                this._textLinesLimit = _textLinesLimit;
            }
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @return {?}
     */
    SdsTruncateTextByLineDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.initialText = this._element.nativeElement.innerText.trim();
        // Clone element to facilitate calculations
        /** @type {?} */
        var hostCloneEl = (/** @type {?} */ (this._element.nativeElement.cloneNode()));
        // Add 1 character to calculate character width
        hostCloneEl.innerHTML = 'x';
        // Render the clone to get character width
        this._element.nativeElement.parentElement.appendChild(hostCloneEl);
        // Set the clone to inline to prevent cases where the clone
        // expands to 100% width of the container
        hostCloneEl.setAttribute('style', 'display: inline');
        // These are close approximations that are used to better guess
        // how many characters fit in X number of lines
        this.approximatedCharacterWidth = hostCloneEl.offsetWidth;
        // Remove clone after calculations
        hostCloneEl.remove();
    };
    /**
     * @return {?}
     */
    SdsTruncateTextByLineDirective.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.windowResize$ = this._viewportRuler
            .change(0)
            .pipe(startWith('Start'))
            .subscribe((/**
         * @return {?}
         */
        function () { return _this.updateUI(); }));
    };
    /**
     * @return {?}
     */
    SdsTruncateTextByLineDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (this._overlayRef) {
            this._overlayRef.dispose();
        }
        this._closingActionsSubscription.unsubscribe();
        this.windowResize$.unsubscribe();
    };
    /** Configures and creates the CDK overlay */
    /**
     * Configures and creates the CDK overlay
     * @private
     * @return {?}
     */
    SdsTruncateTextByLineDirective.prototype._createOverlay = /**
     * Configures and creates the CDK overlay
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var overlayPositions = {
            originX: 'start',
            originY: 'bottom',
            overlayX: 'start',
            overlayY: 'top'
        };
        /** @type {?} */
        var config = new OverlayConfig({
            positionStrategy: this._overlay
                .position()
                .flexibleConnectedTo(this._element)
                .withLockedPosition()
                .withPositions([overlayPositions])
                .withTransformOriginOn('.sds-overlay'),
            hasBackdrop: true,
            backdropClass: 'cdk-overlay-transparent-backdrop',
            scrollStrategy: this._overlay.scrollStrategies.close()
        });
        return this._overlay.create(config);
    };
    /** Attach a ComponentPortal to the overlay **/
    /**
     * Attach a ComponentPortal to the overlay *
     * @private
     * @param {?} overlay
     * @return {?}
     */
    SdsTruncateTextByLineDirective.prototype._attachContainer = /**
     * Attach a ComponentPortal to the overlay *
     * @private
     * @param {?} overlay
     * @return {?}
     */
    function (overlay) {
        /** @type {?} */
        var injector = new PortalInjector(this._injector, new WeakMap([[SDS_TRUNCATED_TEXT_DATA, { text: this.initialText }]]));
        /** @type {?} */
        var containerPortal = new ComponentPortal(SdsTruncatedTextContainerComponent, this._viewContainerRef, injector);
        /** @type {?} */
        var containerRef = overlay.attach(containerPortal);
        return containerRef.instance;
    };
    /** Returns a stream that emits whenever an action that should close the overlay occurs. */
    /**
     * Returns a stream that emits whenever an action that should close the overlay occurs.
     * @private
     * @return {?}
     */
    SdsTruncateTextByLineDirective.prototype._overlayClosingActions = /**
     * Returns a stream that emits whenever an action that should close the overlay occurs.
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var backdrop = this._overlayRef.backdropClick();
        /** @type {?} */
        var detachments = this._overlayRef.detachments();
        return merge(backdrop, detachments);
    };
    /** Width of host element */
    /**
     * Width of host element
     * @private
     * @return {?}
     */
    SdsTruncateTextByLineDirective.prototype._getHostWidth = /**
     * Width of host element
     * @private
     * @return {?}
     */
    function () {
        return this._element.nativeElement.offsetWidth;
    };
    /** Approximated number of characters that are visible in the container */
    /**
     * Approximated number of characters that are visible in the container
     * @private
     * @return {?}
     */
    SdsTruncateTextByLineDirective.prototype._getVisibleCharacters = /**
     * Approximated number of characters that are visible in the container
     * @private
     * @return {?}
     */
    function () {
        return Math.floor((this._getHostWidth() / this.approximatedCharacterWidth) *
            this.textLinesLimit);
    };
    /**
     * @private
     * @return {?}
     */
    SdsTruncateTextByLineDirective.prototype._isNotLongEnough = /**
     * @private
     * @return {?}
     */
    function () {
        return this._getVisibleCharacters() > this.initialText.length;
    };
    /**
     * @return {?}
     */
    SdsTruncateTextByLineDirective.prototype.openOverlay = /**
     * @return {?}
     */
    function () {
        var _this = this;
        // Exit if all text can be visible in container
        if (this._isNotLongEnough())
            return;
        this._overlayRef = this._createOverlay();
        /** @type {?} */
        var container = this._attachContainer(this._overlayRef);
        this._closingActionsSubscription = this._overlayClosingActions().subscribe((/**
         * @return {?}
         */
        function () { return _this.closeOverlay(); }));
        // Wait for the next event loop tick to start the animation
        setTimeout((/**
         * @return {?}
         */
        function () {
            container.startAnimation();
        }));
    };
    /**
     * @return {?}
     */
    SdsTruncateTextByLineDirective.prototype.updateUI = /**
     * @return {?}
     */
    function () {
        // Exit if all text can be visible in container
        if (this._isNotLongEnough())
            return;
        /** @type {?} */
        var wordCut = false;
        /** @type {?} */
        var ellipsis = '...';
        /** @type {?} */
        var limit = this._getVisibleCharacters() - ellipsis.length;
        /** @type {?} */
        var visibleText = this.initialText.slice(0, limit);
        if (!wordCut) {
            /** @type {?} */
            var isEndofWord = this.initialText.substr(limit, limit + 1) === ' ';
            if (!isEndofWord) {
                /** @type {?} */
                var previousWord = visibleText.lastIndexOf(' ');
                visibleText = visibleText.slice(0, previousWord);
            }
        }
        this._element.nativeElement.innerText = visibleText + ellipsis;
    };
    /**
     * @return {?}
     */
    SdsTruncateTextByLineDirective.prototype.closeOverlay = /**
     * @return {?}
     */
    function () {
        this._closingActionsSubscription.unsubscribe();
        this._overlayRef.detach();
    };
    SdsTruncateTextByLineDirective.decorators = [
        { type: Directive, args: [{ selector: '[sdsTruncateTextByLine]' },] }
    ];
    /** @nocollapse */
    SdsTruncateTextByLineDirective.ctorParameters = function () { return [
        { type: Overlay },
        { type: Injector },
        { type: ElementRef },
        { type: ViewportRuler },
        { type: ViewContainerRef }
    ]; };
    SdsTruncateTextByLineDirective.propDecorators = {
        textLinesLimit: [{ type: Input, args: ['sdsTruncateTextByLine',] }],
        openOverlay: [{ type: HostListener, args: ['click',] }]
    };
    return SdsTruncateTextByLineDirective;
}());
export { SdsTruncateTextByLineDirective };
if (false) {
    /**
     * @type {?}
     * @private
     */
    SdsTruncateTextByLineDirective.prototype._textLinesLimit;
    /**
     * PortalOutlet
     * @type {?}
     * @private
     */
    SdsTruncateTextByLineDirective.prototype._overlayRef;
    /**
     * Holds subscription to stream of overlay closing events
     * @type {?}
     * @private
     */
    SdsTruncateTextByLineDirective.prototype._closingActionsSubscription;
    /**
     * Holds initial text
     * @type {?}
     * @private
     */
    SdsTruncateTextByLineDirective.prototype.initialText;
    /**
     * Subscription to window resize stream
     * @type {?}
     */
    SdsTruncateTextByLineDirective.prototype.windowResize$;
    /**
     * Approximated character width of the host text
     * @type {?}
     * @private
     */
    SdsTruncateTextByLineDirective.prototype.approximatedCharacterWidth;
    /**
     * @type {?}
     * @private
     */
    SdsTruncateTextByLineDirective.prototype._overlay;
    /**
     * @type {?}
     * @private
     */
    SdsTruncateTextByLineDirective.prototype._injector;
    /**
     * @type {?}
     * @private
     */
    SdsTruncateTextByLineDirective.prototype._element;
    /**
     * @type {?}
     * @private
     */
    SdsTruncateTextByLineDirective.prototype._viewportRuler;
    /**
     * @type {?}
     * @private
     */
    SdsTruncateTextByLineDirective.prototype._viewContainerRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJ1bmNhdGUtdGV4dC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ3NhLXNhbS9jb21wb25lbnRzLyIsInNvdXJjZXMiOlsibGliL3RydW5jYXRlLXRleHQvdHJ1bmNhdGUtdGV4dC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsVUFBVSxFQUVWLEtBQUssRUFHTCxZQUFZLEVBQ1osUUFBUSxFQUNSLGdCQUFnQixFQUNqQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM3RCxPQUFPLEVBQ0wsYUFBYSxFQUNiLGFBQWEsRUFDYixPQUFPLEVBR1IsTUFBTSxzQkFBc0IsQ0FBQztBQUM5QixPQUFPLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLGNBQWMsRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RSxPQUFPLEVBQUUsa0NBQWtDLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUN6RixPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUVoRTtJQStCRSx3Q0FDVSxRQUFpQixFQUNqQixTQUFtQixFQUNuQixRQUFvQixFQUNwQixjQUE2QixFQUM3QixpQkFBbUM7UUFKbkMsYUFBUSxHQUFSLFFBQVEsQ0FBUztRQUNqQixjQUFTLEdBQVQsU0FBUyxDQUFVO1FBQ25CLGFBQVEsR0FBUixRQUFRLENBQVk7UUFDcEIsbUJBQWMsR0FBZCxjQUFjLENBQWU7UUFDN0Isc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFrQjs7OztRQW5CckMsZ0JBQVcsR0FBc0IsSUFBSSxDQUFDOzs7O1FBR3RDLGdDQUEyQixHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUM7SUFp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LFFBQVEsQ0FBQztJQUNqRSxDQUFDOzs7O0lBRUQscURBQVk7OztJQUFaO1FBQ0UsSUFBSSxDQUFDLDJCQUEyQixDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQy9DLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDNUIsQ0FBQzs7Z0JBcExGLFNBQVMsU0FBQyxFQUFFLFFBQVEsRUFBRSx5QkFBeUIsRUFBRTs7OztnQkFWaEQsT0FBTztnQkFQUCxRQUFRO2dCQU5SLFVBQVU7Z0JBV1YsYUFBYTtnQkFKYixnQkFBZ0I7OztpQ0FvQmYsS0FBSyxTQUFDLHVCQUF1Qjs4QkF3STdCLFlBQVksU0FBQyxPQUFPOztJQXlDdkIscUNBQUM7Q0FBQSxBQXJMRCxJQXFMQztTQXBMWSw4QkFBOEI7Ozs7OztJQWF6Qyx5REFBZ0M7Ozs7OztJQUdoQyxxREFBOEM7Ozs7OztJQUc5QyxxRUFBeUQ7Ozs7OztJQUd6RCxxREFBNEI7Ozs7O0lBRzVCLHVEQUE0Qjs7Ozs7O0lBRzVCLG9FQUEyQzs7Ozs7SUFHekMsa0RBQXlCOzs7OztJQUN6QixtREFBMkI7Ozs7O0lBQzNCLGtEQUE0Qjs7Ozs7SUFDNUIsd0RBQXFDOzs7OztJQUNyQywyREFBMkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBEaXJlY3RpdmUsXG4gIEVsZW1lbnRSZWYsXG4gIE9uSW5pdCxcbiAgSW5wdXQsXG4gIE9uRGVzdHJveSxcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgSG9zdExpc3RlbmVyLFxuICBJbmplY3RvcixcbiAgVmlld0NvbnRhaW5lclJlZlxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGNvZXJjZU51bWJlclByb3BlcnR5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2NvZXJjaW9uJztcbmltcG9ydCB7XG4gIFZpZXdwb3J0UnVsZXIsXG4gIE92ZXJsYXlDb25maWcsXG4gIE92ZXJsYXksXG4gIE92ZXJsYXlSZWYsXG4gIENvbm5lY3RlZFBvc2l0aW9uXG59IGZyb20gJ0Bhbmd1bGFyL2Nkay9vdmVybGF5JztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiwgbWVyZ2UgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHN0YXJ0V2l0aCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFBvcnRhbEluamVjdG9yLCBDb21wb25lbnRQb3J0YWwgfSBmcm9tICdAYW5ndWxhci9jZGsvcG9ydGFsJztcbmltcG9ydCB7IFNkc1RydW5jYXRlZFRleHRDb250YWluZXJDb21wb25lbnQgfSBmcm9tICcuL3RydW5jYXRlLXRleHQtY29udGFpbmVyLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBTRFNfVFJVTkNBVEVEX1RFWFRfREFUQSB9IGZyb20gJy4vdHJ1bmNhdGVzLXRleHQtYmFzZSc7XG5cbkBEaXJlY3RpdmUoeyBzZWxlY3RvcjogJ1tzZHNUcnVuY2F0ZVRleHRCeUxpbmVdJyB9KVxuZXhwb3J0IGNsYXNzIFNkc1RydW5jYXRlVGV4dEJ5TGluZURpcmVjdGl2ZVxuICBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95LCBBZnRlclZpZXdJbml0IHtcbiAgLyoqIE1heGltdW0gbGluZXMgb2YgdGV4dCBsaW1pdCAqL1xuICBASW5wdXQoJ3Nkc1RydW5jYXRlVGV4dEJ5TGluZScpXG4gIGdldCB0ZXh0TGluZXNMaW1pdCgpOiBhbnkge1xuICAgIHJldHVybiB0aGlzLl90ZXh0TGluZXNMaW1pdDtcbiAgfVxuICBzZXQgdGV4dExpbmVzTGltaXQoX3RleHRMaW5lc0xpbWl0OiBhbnkpIHtcbiAgICBfdGV4dExpbmVzTGltaXQgPSBjb2VyY2VOdW1iZXJQcm9wZXJ0eShfdGV4dExpbmVzTGltaXQpO1xuICAgIGlmICh0aGlzLl90ZXh0TGluZXNMaW1pdCAhPT0gX3RleHRMaW5lc0xpbWl0KSB7XG4gICAgICB0aGlzLl90ZXh0TGluZXNMaW1pdCA9IF90ZXh0TGluZXNMaW1pdDtcbiAgICB9XG4gIH1cbiAgcHJpdmF0ZSBfdGV4dExpbmVzTGltaXQ6IG51bWJlcjtcblxuICAvKiogUG9ydGFsT3V0bGV0ICovXG4gIHByaXZhdGUgX292ZXJsYXlSZWY6IE92ZXJsYXlSZWYgfCBudWxsID0gbnVsbDtcblxuICAvKiogSG9sZHMgc3Vic2NyaXB0aW9uIHRvIHN0cmVhbSBvZiBvdmVybGF5IGNsb3NpbmcgZXZlbnRzICovXG4gIHByaXZhdGUgX2Nsb3NpbmdBY3Rpb25zU3Vic2NyaXB0aW9uID0gU3Vic2NyaXB0aW9uLkVNUFRZO1xuXG4gIC8qKiBIb2xkcyBpbml0aWFsIHRleHQgKi9cbiAgcHJpdmF0ZSBpbml0aWFsVGV4dDogc3RyaW5nO1xuXG4gIC8qKiBTdWJzY3JpcHRpb24gdG8gd2luZG93IHJlc2l6ZSBzdHJlYW0gKi9cbiAgd2luZG93UmVzaXplJDogU3Vic2NyaXB0aW9uO1xuXG4gIC8qKiBBcHByb3hpbWF0ZWQgY2hhcmFjdGVyIHdpZHRoIG9mIHRoZSBob3N0IHRleHQgKi9cbiAgcHJpdmF0ZSBhcHByb3hpbWF0ZWRDaGFyYWN0ZXJXaWR0aDogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgX292ZXJsYXk6IE92ZXJsYXksXG4gICAgcHJpdmF0ZSBfaW5qZWN0b3I6IEluamVjdG9yLFxuICAgIHByaXZhdGUgX2VsZW1lbnQ6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSBfdmlld3BvcnRSdWxlcjogVmlld3BvcnRSdWxlcixcbiAgICBwcml2YXRlIF92aWV3Q29udGFpbmVyUmVmOiBWaWV3Q29udGFpbmVyUmVmXG4gICkge31cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmluaXRpYWxUZXh0ID0gdGhpcy5fZWxlbWVudC5uYXRpdmVFbGVtZW50LmlubmVyVGV4dC50cmltKCk7XG5cbiAgICAvLyBDbG9uZSBlbGVtZW50IHRvIGZhY2lsaXRhdGUgY2FsY3VsYXRpb25zXG4gICAgY29uc3QgaG9zdENsb25lRWwgPSB0aGlzLl9lbGVtZW50Lm5hdGl2ZUVsZW1lbnQuY2xvbmVOb2RlKCkgYXMgSFRNTEVsZW1lbnQ7XG5cbiAgICAvLyBBZGQgMSBjaGFyYWN0ZXIgdG8gY2FsY3VsYXRlIGNoYXJhY3RlciB3aWR0aFxuICAgIGhvc3RDbG9uZUVsLmlubmVySFRNTCA9ICd4JztcblxuICAgIC8vIFJlbmRlciB0aGUgY2xvbmUgdG8gZ2V0IGNoYXJhY3RlciB3aWR0aFxuICAgIHRoaXMuX2VsZW1lbnQubmF0aXZlRWxlbWVudC5wYXJlbnRFbGVtZW50LmFwcGVuZENoaWxkKGhvc3RDbG9uZUVsKTtcblxuICAgIC8vIFNldCB0aGUgY2xvbmUgdG8gaW5saW5lIHRvIHByZXZlbnQgY2FzZXMgd2hlcmUgdGhlIGNsb25lXG4gICAgLy8gZXhwYW5kcyB0byAxMDAlIHdpZHRoIG9mIHRoZSBjb250YWluZXJcbiAgICBob3N0Q2xvbmVFbC5zZXRBdHRyaWJ1dGUoJ3N0eWxlJywgJ2Rpc3BsYXk6IGlubGluZScpO1xuXG4gICAgLy8gVGhlc2UgYXJlIGNsb3NlIGFwcHJveGltYXRpb25zIHRoYXQgYXJlIHVzZWQgdG8gYmV0dGVyIGd1ZXNzXG4gICAgLy8gaG93IG1hbnkgY2hhcmFjdGVycyBmaXQgaW4gWCBudW1iZXIgb2YgbGluZXNcbiAgICB0aGlzLmFwcHJveGltYXRlZENoYXJhY3RlcldpZHRoID0gaG9zdENsb25lRWwub2Zmc2V0V2lkdGg7XG5cbiAgICAvLyBSZW1vdmUgY2xvbmUgYWZ0ZXIgY2FsY3VsYXRpb25zXG4gICAgaG9zdENsb25lRWwucmVtb3ZlKCk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgdGhpcy53aW5kb3dSZXNpemUkID0gdGhpcy5fdmlld3BvcnRSdWxlclxuICAgICAgLmNoYW5nZSgwKVxuICAgICAgLnBpcGUoc3RhcnRXaXRoKCdTdGFydCcpKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLnVwZGF0ZVVJKCkpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX292ZXJsYXlSZWYpIHtcbiAgICAgIHRoaXMuX292ZXJsYXlSZWYuZGlzcG9zZSgpO1xuICAgIH1cbiAgICB0aGlzLl9jbG9zaW5nQWN0aW9uc1N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIHRoaXMud2luZG93UmVzaXplJC51bnN1YnNjcmliZSgpO1xuICB9XG5cbiAgLyoqIENvbmZpZ3VyZXMgYW5kIGNyZWF0ZXMgdGhlIENESyBvdmVybGF5ICovXG4gIHByaXZhdGUgX2NyZWF0ZU92ZXJsYXkoKSB7XG4gICAgY29uc3Qgb3ZlcmxheVBvc2l0aW9uczogQ29ubmVjdGVkUG9zaXRpb24gPSB7XG4gICAgICBvcmlnaW5YOiAnc3RhcnQnLFxuICAgICAgb3JpZ2luWTogJ2JvdHRvbScsXG4gICAgICBvdmVybGF5WDogJ3N0YXJ0JyxcbiAgICAgIG92ZXJsYXlZOiAndG9wJ1xuICAgIH07XG4gICAgY29uc3QgY29uZmlnID0gbmV3IE92ZXJsYXlDb25maWcoe1xuICAgICAgcG9zaXRpb25TdHJhdGVneTogdGhpcy5fb3ZlcmxheVxuICAgICAgICAucG9zaXRpb24oKVxuICAgICAgICAuZmxleGlibGVDb25uZWN0ZWRUbyh0aGlzLl9lbGVtZW50KVxuICAgICAgICAud2l0aExvY2tlZFBvc2l0aW9uKClcbiAgICAgICAgLndpdGhQb3NpdGlvbnMoW292ZXJsYXlQb3NpdGlvbnNdKVxuICAgICAgICAud2l0aFRyYW5zZm9ybU9yaWdpbk9uKCcuc2RzLW92ZXJsYXknKSxcbiAgICAgIGhhc0JhY2tkcm9wOiB0cnVlLFxuICAgICAgYmFja2Ryb3BDbGFzczogJ2Nkay1vdmVybGF5LXRyYW5zcGFyZW50LWJhY2tkcm9wJyxcbiAgICAgIHNjcm9sbFN0cmF0ZWd5OiB0aGlzLl9vdmVybGF5LnNjcm9sbFN0cmF0ZWdpZXMuY2xvc2UoKVxuICAgIH0pO1xuICAgIHJldHVybiB0aGlzLl9vdmVybGF5LmNyZWF0ZShjb25maWcpO1xuICB9XG5cbiAgLyoqIEF0dGFjaCBhIENvbXBvbmVudFBvcnRhbCB0byB0aGUgb3ZlcmxheSAqKi9cbiAgcHJpdmF0ZSBfYXR0YWNoQ29udGFpbmVyKG92ZXJsYXk6IE92ZXJsYXlSZWYpIHtcbiAgICBjb25zdCBpbmplY3RvciA9IG5ldyBQb3J0YWxJbmplY3RvcihcbiAgICAgIHRoaXMuX2luamVjdG9yLFxuICAgICAgbmV3IFdlYWtNYXAoW1tTRFNfVFJVTkNBVEVEX1RFWFRfREFUQSwgeyB0ZXh0OiB0aGlzLmluaXRpYWxUZXh0IH1dXSlcbiAgICApO1xuICAgIGNvbnN0IGNvbnRhaW5lclBvcnRhbCA9IG5ldyBDb21wb25lbnRQb3J0YWwoXG4gICAgICBTZHNUcnVuY2F0ZWRUZXh0Q29udGFpbmVyQ29tcG9uZW50LFxuICAgICAgdGhpcy5fdmlld0NvbnRhaW5lclJlZixcbiAgICAgIGluamVjdG9yXG4gICAgKTtcbiAgICBjb25zdCBjb250YWluZXJSZWYgPSBvdmVybGF5LmF0dGFjaChjb250YWluZXJQb3J0YWwpO1xuXG4gICAgcmV0dXJuIGNvbnRhaW5lclJlZi5pbnN0YW5jZTtcbiAgfVxuXG4gIC8qKiBSZXR1cm5zIGEgc3RyZWFtIHRoYXQgZW1pdHMgd2hlbmV2ZXIgYW4gYWN0aW9uIHRoYXQgc2hvdWxkIGNsb3NlIHRoZSBvdmVybGF5IG9jY3Vycy4gKi9cbiAgcHJpdmF0ZSBfb3ZlcmxheUNsb3NpbmdBY3Rpb25zKCkge1xuICAgIGNvbnN0IGJhY2tkcm9wID0gdGhpcy5fb3ZlcmxheVJlZi5iYWNrZHJvcENsaWNrKCk7XG4gICAgY29uc3QgZGV0YWNobWVudHMgPSB0aGlzLl9vdmVybGF5UmVmLmRldGFjaG1lbnRzKCk7XG4gICAgcmV0dXJuIG1lcmdlKGJhY2tkcm9wLCBkZXRhY2htZW50cyk7XG4gIH1cblxuICAvKiogV2lkdGggb2YgaG9zdCBlbGVtZW50ICovXG4gIHByaXZhdGUgX2dldEhvc3RXaWR0aCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLl9lbGVtZW50Lm5hdGl2ZUVsZW1lbnQub2Zmc2V0V2lkdGg7XG4gIH1cblxuICAvKiogQXBwcm94aW1hdGVkIG51bWJlciBvZiBjaGFyYWN0ZXJzIHRoYXQgYXJlIHZpc2libGUgaW4gdGhlIGNvbnRhaW5lciAqL1xuICBwcml2YXRlIF9nZXRWaXNpYmxlQ2hhcmFjdGVycygpOiBudW1iZXIge1xuICAgIHJldHVybiBNYXRoLmZsb29yKFxuICAgICAgKHRoaXMuX2dldEhvc3RXaWR0aCgpIC8gdGhpcy5hcHByb3hpbWF0ZWRDaGFyYWN0ZXJXaWR0aCkgKlxuICAgICAgICB0aGlzLnRleHRMaW5lc0xpbWl0XG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgX2lzTm90TG9uZ0Vub3VnaCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5fZ2V0VmlzaWJsZUNoYXJhY3RlcnMoKSA+IHRoaXMuaW5pdGlhbFRleHQubGVuZ3RoO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcignY2xpY2snKVxuICBvcGVuT3ZlcmxheSgpOiB2b2lkIHtcbiAgICAvLyBFeGl0IGlmIGFsbCB0ZXh0IGNhbiBiZSB2aXNpYmxlIGluIGNvbnRhaW5lclxuICAgIGlmICh0aGlzLl9pc05vdExvbmdFbm91Z2goKSkgcmV0dXJuO1xuXG4gICAgdGhpcy5fb3ZlcmxheVJlZiA9IHRoaXMuX2NyZWF0ZU92ZXJsYXkoKTtcbiAgICBjb25zdCBjb250YWluZXIgPSB0aGlzLl9hdHRhY2hDb250YWluZXIodGhpcy5fb3ZlcmxheVJlZik7XG4gICAgdGhpcy5fY2xvc2luZ0FjdGlvbnNTdWJzY3JpcHRpb24gPSB0aGlzLl9vdmVybGF5Q2xvc2luZ0FjdGlvbnMoKS5zdWJzY3JpYmUoXG4gICAgICAoKSA9PiB0aGlzLmNsb3NlT3ZlcmxheSgpXG4gICAgKTtcbiAgICAvLyBXYWl0IGZvciB0aGUgbmV4dCBldmVudCBsb29wIHRpY2sgdG8gc3RhcnQgdGhlIGFuaW1hdGlvblxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgY29udGFpbmVyLnN0YXJ0QW5pbWF0aW9uKCk7XG4gICAgfSk7XG4gIH1cblxuICB1cGRhdGVVSSgpIHtcbiAgICAvLyBFeGl0IGlmIGFsbCB0ZXh0IGNhbiBiZSB2aXNpYmxlIGluIGNvbnRhaW5lclxuICAgIGlmICh0aGlzLl9pc05vdExvbmdFbm91Z2goKSkgcmV0dXJuO1xuXG4gICAgY29uc3Qgd29yZEN1dCA9IGZhbHNlO1xuICAgIGNvbnN0IGVsbGlwc2lzID0gJy4uLic7XG4gICAgY29uc3QgbGltaXQgPSB0aGlzLl9nZXRWaXNpYmxlQ2hhcmFjdGVycygpIC0gZWxsaXBzaXMubGVuZ3RoO1xuXG4gICAgbGV0IHZpc2libGVUZXh0ID0gdGhpcy5pbml0aWFsVGV4dC5zbGljZSgwLCBsaW1pdCk7XG5cbiAgICBpZiAoIXdvcmRDdXQpIHtcbiAgICAgIGNvbnN0IGlzRW5kb2ZXb3JkID0gdGhpcy5pbml0aWFsVGV4dC5zdWJzdHIobGltaXQsIGxpbWl0ICsgMSkgPT09ICcgJztcbiAgICAgIGlmICghaXNFbmRvZldvcmQpIHtcbiAgICAgICAgY29uc3QgcHJldmlvdXNXb3JkID0gdmlzaWJsZVRleHQubGFzdEluZGV4T2YoJyAnKTtcbiAgICAgICAgdmlzaWJsZVRleHQgPSB2aXNpYmxlVGV4dC5zbGljZSgwLCBwcmV2aW91c1dvcmQpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuX2VsZW1lbnQubmF0aXZlRWxlbWVudC5pbm5lclRleHQgPSB2aXNpYmxlVGV4dCArIGVsbGlwc2lzO1xuICB9XG5cbiAgY2xvc2VPdmVybGF5KCkge1xuICAgIHRoaXMuX2Nsb3NpbmdBY3Rpb25zU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgdGhpcy5fb3ZlcmxheVJlZi5kZXRhY2goKTtcbiAgfVxufVxuIl19